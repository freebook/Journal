<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V5.0//EN"
	"/usr/share/xml/docbook/schema/dtd/5.0/docbook.dtd" [
	<!ENTITY article.author.xml 		SYSTEM "../common/article.author.xml">
	<!ENTITY book.info.legalnotice.xml 	SYSTEM "../common/book.info.legalnotice.xml">
	<!ENTITY book.info.abstract.xml		SYSTEM "../common/book.info.abstract.xml">
]>
<article xml:base="http://netkiller.github.io/journal/"
	xmlns="http://docbook.org/ns/docbook" xml:lang="zh-cn">
	<articleinfo>
		<title>贵金属交易系统异地灾备方案</title>
		<subtitle>http://netkiller.github.io/journal/trader.html</subtitle>
		&article.author.xml;
		&book.info.legalnotice.xml;
		<abstract>

		</abstract>
		&book.info.abstract.xml;
		<keywordset>
			<keyword>MT4, MT5, MetaTrader</keyword>
			<keyword></keyword>
			<keyword></keyword>
			<keyword></keyword>
		</keywordset>
		<pubdate>$Date$</pubdate>
		<release>$Id$</release>
	</articleinfo>
	<section>
		<title>背景</title>
		<para>随着贵金属交易的推出，贵金属市场必将非常活跃，交易量的快速增加对交易系统产生了更大的压力，如何使交易系统平稳运行，成为贵金属公司的头等大事。
		随着客户风险意识的增强，保证关键核心业务系统持续成功运作的需要，将发生风险的损失降到最低，保证企业的核心竞争力，贵金属公司对交易系统的可靠性提出了更高的要求。
		目前贵金属公司普遍安装了热备份系统，达到了一定程度上的备份，但无法应对整个机房或大楼的灾难事故，这就需要在异地建立一套贵金属交易系统，一旦主系统发生问题，且无法启动热备的情况下，马上切换到异地灾备系统进行交易。
		</para>
		<section>
			<title>建立容灾系统需要考虑哪些因素</title>
			<para>与简单地将一部分数据从一台机器拷贝到另一台机器相比，企业内业务数据的复制要复杂的多。灾备系统必须满足以下所有业务需求：</para>
			<screen>
i. 数据的高可用性：灾备系统应具有可靠性，同时灾备系统的计算机系统故障不应影响业务的正常操作，达到 (Recovery Time Objective) “恢复时间目标”的要求。
ii. 减少数据丢失：达到 RPO (Recovery Point Objective)“恢复点目标”的要求。作为灾备的系统，最主要的功能是将交易过程中的数据能在最短的延时情况下，同步到灾备系统，最低限度丢失数据。
iii. 高性能：灾备系统不应影响数据源系统的正常运行，应当高效地利用网络，并允许各点采用最优化的方法存取本地数据。
iv. 提高投资回报率：利用备份系统来支撑其他业务，以提高系统的利用率
			</screen>
		</section>
		<section>
			<title>目前容灾系统的实现方式</title>
			<screen>
i. 基于存储复制的容灾----通过复制磁盘IO 的方式，从生产中心向容灾中心进行数据容灾，根据复制设备的不同，又可以分为：
——基于主机
——基于磁盘阵列
——基于智能SAN
——虚拟存储设备
ii. 基于数据库的容灾----通过复制数据库日志或者数据文件方式，从生产中心向容灾中心进行数据容灾
iii. 基于应用的容灾----应用指向2个同时运作的数据中心，在任意一个中心活动情况下继续工作
			</screen>
		</section>
		<section>
			<title>系统灾难恢复等级划分</title>
			<para>系统灾难恢复有国际标准，我国也有自己的系统灾难恢复标准，一般分为六个等级，但我觉得都较为过时，不符合互联网时代 。</para>
			<orderedlist>
				<title>我国灾难恢复等级划分国信办文件   2005  “重要信息系统灾难恢复指南”</title>
				<listitem>“第1级”：数据介质转移（备份介质异地存放和定期更新）</listitem>
				<listitem>“第2级”：备用场地支持（异地介质存放和备份中心支持）</listitem>
				<listitem>“第3级”：电子传送和部分设备支持 </listitem>
				<listitem>“第4级”：电子传送和完整设备支持 </listitem>
				<listitem>“第5级”：实时数据传送及完整设备支持 </listitem>
				<listitem>“第6级”：零数据丢失</listitem>
			</orderedlist>
			<para>我认为等级划分应该为</para>
			<orderedlist>
				<title>灾难恢复等级划分</title>
				<listitem><para>第一级：冷备份</para></listitem>
				<listitem><para>第二级：双机热设备份（HA高可用, 通常为 Active Standby）</para></listitem>
				<listitem><para>第三级：双活互备份（Active-Active 双机互备）</para></listitem>
				<listitem><para>第四级：负载均衡（随时新增节点，移除节点，横向扩展）</para></listitem>
				<listitem><para>第五级：异地灾备</para></listitem>
				<listitem><para>第六级：全球负载均衡（分布式灾备）</para></listitem>
			</orderedlist>
			<para>从第二级开始就具备“零数据丢失”，远远高于国家标准与国际标准。一级可能需要人工介入，但从第二级开始都是无人值守，到第三级可以达到7*24*365不停机运转，实现智能故障转移。</para>
		</section>
	</section>
	<section>
		<title>数据中心网络篇</title>
		<para>满足灾备前提是网络畅通无阻，同时网络拓扑设计能够支持灾备。</para>
		<orderedlist>
			<title>数据中心要求</title>
			<listitem><para>供电要求：双路供电，电力来自不同的发电厂，UPS 后备电源，柴油发电机组</para></listitem>
			<listitem><para>空调要求：通常从地面送风的机房比较好</para></listitem>
			<listitem><para>室内气体监控：数据中心应该具备气体监控，室内粉尘，湿度监控</para></listitem>
			<listitem><para>消防：</para></listitem>
			<listitem><para>机柜：机会有很多规格，虽然都能放入机架服务器，但有些比较小，没有提供电源线与网路槽。220V电源与网线混在一起可能造成一定的数据丢包。</para></listitem>
			<listitem><para>网络设备：我常常考察一个机房会看他们的核心出口设备</para></listitem>
		</orderedlist>
		<section>
			<title>单机房高可用双活互备解决方案</title>
			<figure><title>单机房高可用双活互备解决方案</title>
				<graphic srccredit="Neo Chen, 2014" fileref="images/trader/network/trader_double_AA_system.png"/>
			</figure>
			<para>但机房最大的优势是网络连接比较方便，很多公司购买的机柜相邻，可能从机柜上方走线。</para>
			<para>双机热备这种我认为是过时的技术，常常主系统出现故障时，你会发现备用系统无法工作。所以我设计的系统都是AA(Active-Active)所有节点都对外提供服务，能够更早的发现问题。</para>
		</section>
		<section>
			<title>双机房互备异地灾备方案</title>
			<figure><title>双机房异地灾备方案</title>
				<graphic srccredit="Neo Chen, 2014" fileref="images/trader/network/trader_remote_double_system.png"/>
			</figure>
			<para>异地灾备通常将两个机房打通，但是由于线路带宽有限(通常是1G双绞线或光纤 )我能做太复杂连接。通常我们将这条线主要用户数据复制，状态同步，其他服务器独立工作。</para>
		</section>
		<section>
			<title>三机房互备异地灾备方案</title>
			<figure><title>三机房互备异地灾备方案</title>
				<graphic srccredit="Neo Chen, 2014" fileref="images/trader/network/trader_three_places_system.png"/>
			</figure>
			<para>三机房安全级别更高，采用三角路由方案，任何时刻都有两条链路是畅通的，通过路由表优化决定一下跳，而且可以绕过故障节点。</para>
			<para>三机房有三个入口，通过智能DNS将用户解析到距离自己最近的节点上，用户也可以在交易软件端手动选择。</para>
			<para>三机房的数据库采用环形复制</para>
		</section>
	</section>
	
	<section>
		<title>数据中心服务器篇</title>
		<para>一旦数据中心网络部分完成，下一步就是部署各种服务器，同时服务器的部署必须满足灾备的要求，否则无法实现灾备切换与故障转移。</para>
		<para>服务器与交换机连接，按照服务器重要程度或者是否具备故障转移，有两种方案，如具备分布式部署的服务器可能只连接一条网线，有些服务器无法分布式部署，我们是两个网卡分别连接两条网线到两台交换机，同时网卡绑定为一个适配器。</para>
		<section>
			<title>网站</title>
			<para>网站提供新闻，资讯，开户，转帐，活动，报表，在线客服等等功能</para>
			<figure><title>动态页面方案</title>
				<graphic srccredit="Neo Chen, 2014" fileref="images/trader/server/website_activepage.png"/>
			</figure>
			<para>上面是动态页面方案，分为SSL服务器，WEB服务器，API接口服务器，Admin服务器。全部具备水平扩展与动态伸缩。下面分别详细说明他们的功能，为什么这样部署。</para>
			<orderedlist>
				<title>动态页面服务器</title>
				<listitem><para>SSL：负责处理用户请求的加密与解密，我们将它与WEB分离，这样能够更好的伸缩扩展，同时提供故障转移功能，我们可以部署很多台这样的服务器。在不同城市，然后通过智能DNS将用户解析到距离用户最近的节点上。</para></listitem>
				<listitem><para>WEB：动态页面服务器</para></listitem>
				<listitem><para>API： Service 服务器，可以通过SOAP, JSON, MQ等等方式访问，WEB任何操作都要请求API服务器完成，WEB服务器不允许直接操作数据库，全交由API处理。API具有运用层防火墙的功能与ACL访问控制列表。</para></listitem>
				<listitem><para>Admin：网站后台</para></listitem>
				<listitem><para>HA：负载均衡软件或设备</para></listitem>
			</orderedlist>
			<para>与门户网站不同，我们的网站访问量并不大，性能瓶颈基本不存在，更多是考虑高可用。</para>
			<para>静态页面以及CDN部门这里就不谈了，非常简单，有兴趣可能到<ulink url="http://netkiller.github.io/" />找相关资料。</para>
		</section>
		<section>
			<title>数据源</title>
			<para>在交易过程中出现报盘中断是大忌，我们必须尽一切努力，让交易系统能源源不断的接收价格数据。为此我需要重点考虑数据源的灾备。</para>
			<figure><title>数据源灾备解决方案</title>
				<graphic srccredit="Neo Chen, 2014" fileref="images/trader/server/datafeed.png"/>
			</figure>
			<para>我们设计了一个DataFeed程序，能够多方接收数据，因为每个数据源提供的产品不同。我们在这里可以合并，筛选，过滤等等。这个应用可以实现水平扩展，我们可以放在2个以上的机房当中。</para>
			<para>接下来在交易服务器中，设置多个数据源分别指向Data Feed 1,2~n。与Trader相同机房的DataFeed的优先级总是最高。</para>
		</section>
		<section>
			<title>数据库</title>
			<para>数据的部署要考虑几个问题，我一直不建议主备方案，而是采用双活方案。所以我们要考虑两个机房或者三个机房他们数据复制问题，性能瓶颈问题，数据安全问题等等</para>
			<figure><title>数据库灾备解决方案</title>
				<graphic srccredit="Neo Chen, 2014" fileref="images/trader/server/database.png"/>
			</figure>
			<para>上图我的方案中采用了Master-Master双活方案，同时每个Master都会有一个Slave。Master 主要用于主要的业务，Slave主要用户数据分析，报表查询等等非实时，且长时间允许等等查询服务</para>
			<para>数据库访问需要经过SLB服务器，为数据库提供负载均衡，故障转移，水平扩展等等功能。</para>
			<para>所有的数据操作只能通过API完成，不能直接连接数据库并通过SQL存取，上面已经提到过，这里不再多讲。</para>
			<tip>如果是三个以上机房，将采用环形复制，大致原理Master A向Master B复制，Master B向 Master C复制，Master C在向Master A 复制，形成一个环路。</tip>
			<para>如果数据库查询如果出现瓶颈，增加Slave即可。</para>
		</section>
	</section>
	
	<section>
		<title>灾备培训和演练</title>
		<section>
			<title>培训对象</title>
			<para>公司灾备应急小组所有成员</para>
			<para>其他感兴趣员工 </para>
		</section>
		<section>
			<title>培训内容</title>
			<orderedlist>
				<listitem><para>灾备原理</para></listitem>
				<listitem><para>灾备中心系统结构（系统部署图、网络结构图）</para></listitem>
				<listitem><para>灾备系统运营维护</para></listitem>
				<listitem><para>公司操作流程</para></listitem>
				<listitem><para>切换操作流程</para></listitem>
				<listitem><para>数据检查与验证</para></listitem>
			</orderedlist>
		</section>
		<section>
			<title>演练环境设置</title>
			<orderedlist>
				<title>业务准备</title>
				<listitem><para>确定演练时间</para></listitem>
				<listitem><para>通知参与演练的客户</para></listitem>
				<listitem><para>通知参与演练的业务部门</para></listitem>
			</orderedlist>
			<orderedlist>
				<title>技术准备</title>
				<listitem><para>做好演练前的数据备份</para></listitem>
				<listitem><para>检查灾备各应用服务状态 </para></listitem>
			</orderedlist>
			<orderedlist>
				<title>参与部门</title>
				<listitem><para>开发部门</para></listitem>
				<listitem><para>测试部门</para></listitem>
				<listitem><para>业务部门</para></listitem>
			</orderedlist>
			<para>模拟灾难: 在演练开始时间，关闭主交易中心的所有的应用，模拟灾难发生。此时，公司应完全按照“公司操作流程”和“灾备系统切换流程”来切换灾备系统。</para>
			<para>演练过程: 见“切换操作”和“公司操作流程”</para>
		</section>
		<section>
			<title>开始演练</title>
			<screen>
灾备切换流程
系统管理员
灾备部门领导
灾备应急小组
报告灾难发生
判断主交易中心是否能短时间恢复交易
获取进行灾备切换授权
N
简单灾难记录
Y灾备切换前准备
切换到灾备中心
切换后检查
切换后报告判断灾备切换是否成功抢修主交易系统
发布消息，通知营业部和客户
严重灾难记录
			</screen>
			<section>
				<title>切换前操作</title>
				<screen>
当主交易系统需要切换到灾备系统时，为避免一部分人连接到主交易系统，一部分人连接到灾备系统，切换前必须关闭主交易系统的应用服务器和银期应用服务器。
灾备系统启用前，数据同步系统必须关闭（包括系统级或应用级），避免影响灾备系统的启动和恢复。
i. 关闭主交易系统app、drtp
ii. 关闭主交易系统的报盘机
iii. 关闭数据采集系统
iv. 关闭主交易系统数据库
v.检查灾备系统各服务器运作的状态，确认灾备系统处于正常工作状态
vi.

				</screen>
			</section>
			<section>
				<title>切换操作</title>
				<screen>
准备好切换后，首先要使灾备系统进入正式服务状态。故先通过灾备切换控制台，清除原来登录主席的各服务器和客户端登录标志，避免终端切换地址后登录不了。
接下来修改周边网关和供营业部接入的通信平台的配置，使它们连接到灾备系统的通讯平台上，为快速切换，可以先准备好连主交易系统和连灾备系统的配置文件，关闭周边网关和通信平台后，用准备好的连灾备系统的配置文件覆盖运行环境下的配置文件，重新启动周边网关和通讯平台。
周边网关和供营业部接入的通讯平台启动后，客户端就可以登录到灾备系统了。

i. 清除服务器和客户端登录标志
ii. 修改周边网关本机的三级通讯平台配置，指向灾备中心
iii.如果有营业部，请同步修改营业部配置文件，指向灾备中心

				</screen>
			</section>
			<section>
				<title>切换后检查</title>
				<screen>
由于数据实时采集同步存在延时以及线路中断可能，导致同步时存在数据丢失，故灾备系统中的数据与主交易系统的数据可能存在不一致，故客户端连上灾备系统后，需要重新登录，获取灾备系统中的数据进行确认，在确认正确后，即可重新进行交易。
应用系统服务状态检查 i. 接口能否正常连到交易所 ii. 网上交易能否正常进行 iii.
交易压力是否正常
公司需要进行多方面的数据核对，包括：
 i. 委托单是否一致
 ii.委托回报是否完整；
iii. 成交回报是否完整；
 iv. 银期数据同步是否完整；
 v. 行情数据是否正确；
vi. 客户风险是否根据行情重新计算；
vii.客户资金是否正常

公司操作流程
i. 报告灾难发生并申请灾备切换
ii. 确认灾难发生并同意灾备切换（主交易中心无法进行正常交易）
iii. 获取授权
iv. 做切换前准备
v. 切换到灾备系统
 vi. 切换后检查
 vii. 切换后报告
viii. 发布消息（通知营业部、客户）
ix. 进行正常交易
x.抢修主交易系统
				</screen>
			</section>
		</section>
		<section>
			<title>演练结果检查</title>
			<orderedlist>
				<title>应用系统服务状态检查</title>
				<listitem><para>主库备库数据是否一致</para></listitem>
				<listitem><para>接口能否正常连到交易所</para></listitem>
				<listitem><para>网上交易能否正常进行</para></listitem>
				<listitem><para>交易压力是否正常</para></listitem>
			</orderedlist>

			<orderedlist>
				<title>公司需要进行多方面的数据核对，包括</title>
				<listitem><para>委托单是否一致, 委托回报是否完整</para></listitem>
				<listitem><para>成交回报是否完整, 交易记录是否完整</para></listitem>
				<listitem><para>行情数据是否正确</para></listitem>
				<listitem><para>客户资金是否正常</para></listitem>
			</orderedlist>
		</section>
		<section>
			<title>可能存在的风险</title>
			<para>当主交易系统切换到灾备系统后，必然会有一些影响业务的情况会发生，公司需要事先有所准备，并制定相关应急预案。 </para>
	 		<section>
				<title>主交易系统短期无法恢复</title>
				<para>由于发生重大事件，可能造成灾害发生时切换到灾备中心的交易系统无法切换回主交易系统。导致交易需要长时间在灾备中心运行，对灾备中心形成压力。对于此情况，公司应该制定详细的预案，保证灾备中心能承担起正常交易压力，使用户交易正常进行。
当确认灾备中心无法在短时间切换回主交易中心时，公司应立即启动预案，并和服务部门联系，请求技术支持。通过增加服务器、增加访问带宽、交易数据备份等方式，使灾备中心转换为主交易系统，长期承担主交易系统交易工作。</para>
			</section>
 			<section>
				<title>切换灾备系统后业务的影响</title>
				<para>在切换以后，有部分业务将受影响，以下为部分情况：</para>
				<screen>
i) 各类终端需要重新登录，如果有业务流水没有同步到灾备系统，则会丢失部分业务数据。
ii) 客户的尚未触发的条件单不再有效也不会再触发，这个必须和客户声明，避免引起纠纷；
iii) 灾备中心建立了银期备份，则可以继续做银期转帐，考虑到可能存在异常情况，可以关闭银期出金。
iv) 第三方交易系统在灾备切换后，也需要进行切换，否则会无法使用。
				</screen>
			</section>
			<section>
				<title>数据不同步产生的影响 </title>
				<para>由于数据同步时，存在延时，故有可能灾备系统和主系统之间线路中断后，有部分已经发生的业务没有同步到灾备系统中，部分业务也会受些影响，故客户端切换到灾备系统中时需要重新登录系统，以便重新查询数据库中的数据进行核对。相关影响如下：</para>
				<screen>
i) 系统参数的修改没有同步，灾备系统中将会按原先的参数进行控制，操作员可以在灾备系统中重新设置；
ii) 客户的费率和权限等没有同步，灾备系统中将会按原先的费率和权限进行控制，操作员可以在灾备系统中重新设置；
iii) 主交易系统中已经生成但没有发往交易所的委托单没有同步，此时灾备系统中将没有这笔记录，且资金是不冻结的；
iv) 主交易系统中已经发往交易所的委托单没有同步，此时灾备系统中将没有这笔记录，且资金是不冻结的，需要通过报盘机补发此笔委托的委托回报；
v) 银期出入金数据没有同步，此时客户的资金将存在问题，特别是出金的客户，在灾备系统中看到的是出金前的资金，若用此资金进行交易，就存在风险，故灾备切换后必须核对银期数据。
				</screen>
			</section>
			<section>
				<title>双活方案可能带来的影响 </title>
				<screen>
i) 由于交易所组合单委托回报信息，缺少组合对应关系，所以会被直接处理成两笔独立的委托，在计算保证金和手续费的的时候，可能有偏差。（这些正与交易所协调，后期也可以通过其他途径完善）
ii) 另外，由于交易信息是从直接报盘机获取的，如下信息，主备系统会有不一致的情况：
 委托时间、申报时间、撤单时间、触发时间：由主备机的机器时间不一致造成的下单操作员、撤单操作员：从委托表中取下单操作员，取不到的话就是调用成交回报接口的操作员
 成交均价：由于成交单顺序不一定一样，因此算得的均价可能会不一样 委托单类型、下单方式、批次号、下单人类型、处理接口、更新批次号、本地标志：这些字段都是接口不返回的东西，所以备机无法知道这些内容
 备注信息：举例，主机撤单请求失败，会写信息到备注。但这笔请求不会发往交易所，备机自然是收不到的。
				</screen>
			</section>
			<section>
				<title>灾备系统中的建议关闭的功能 </title>
				<screen>
切换到灾备系统后，为避免某些业务发生后，不利于系统的处理和恢复，部
分功能建议关闭：
 客户开户  客户销户  客户状态变更  客户资料修改  客户密码修改  客户权限、费率，  交易编码设置
				</screen>
			</section>
		</section>
		<section>
			<title>灾备系统备份</title>
			<para>当灾备中心承担交易时，灾备系统中的所有交易数据将进行备份，供事后的查询和备案。公司可以采用热备系统，备份灾备中心的交易数据。并做好灾备中心数据及时转移到安全位置。确保灾备中心数据不会丢失。</para>
		</section>
		<section>
			<title>系统运营维护</title>
			<screen>
i. 每日数据备份传输恢复
ii. 每日实时数据采集监控
iii.每日关键部位数据校对
iv. 每日无人值守把备份文件传输到备机上
v. 确保app和drtp工作状态正常
vi. 保证灾备中心和主交易系统具备相同版本升级
vii. 确保报盘机配置正确且能正常工作
viii. 每月做一次灾备切换预演，确保备份系统能正常工作
			</screen>
		</section>
	</section>
	
	<section>
		<title>交易软件篇</title>
	</section>
	<section>
		<title>运维篇</title>
	</section>
</article>